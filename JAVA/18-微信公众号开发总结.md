# å¾®ä¿¡å…¬ä¼—å·å¼€å‘æ€»ç»“

> å†™äº2018-08-01
---
> åšè¿‡å‡ ä¸ªå¾®ä¿¡å…¬ä¼—å·ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰æ€»ç»“ã€‚è¿™ç¯‡æ–‡ç« ä»¥SpringBootä¸ºåŸºç¡€ï¼Œ[ä½¿ç”¨GitHubä¸Šçš„ä¸€ä¸ªsdk](https://github.com/Wechat-Group/weixin-java-tools)ï¼ˆ**ç‰¹åˆ«å¥½ç”¨**ï¼‰ï¼Œå¦‚æœä½ æ˜¯æ–°æ‰‹æœ¬æ–‡å¸Œæœ›å¯¹ä½ æœ‰ç”¨ã€‚å®˜æ–¹æ–‡æ¡£å¾ˆå¤šï¼ŒçŸ¥é“ä½ å¿™ï¼ŒæŠŠå…³é”®æ–‡æ¡£æ‰¾æ¥äº†ï¼Œ**ä¸€å®šè¦çœ‹å•Šï¼ï¼ï¼ï¼**

### å‚è€ƒæ–‡çŒ®
- å¾®ä¿¡å®˜æ–¹æ–‡æ¡£ï¼ˆæœ‰ç‚¹å¤šï¼ŒæŒ‰éœ€æŸ¥çœ‹ï¼‰: [æˆ³æˆ‘](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432)
- GitHub sdkæ–‡æ¡£ï¼ˆæœ‰ç‚¹å¤šï¼ŒæŒ‰éœ€æŸ¥çœ‹ï¼‰ï¼š[æˆ³æˆ‘](https://github.com/Wechat-Group/weixin-java-tools/wiki)
- ç½‘é¡µæˆæƒæ‹‰å–ç”¨æˆ·ä¿¡æ¯æ–‡æ¡£ï¼ˆå°±ä¸€é¡µè€Œå·²ï¼‰ï¼š[æˆ³æˆ‘](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140842)
- å¾®ä¿¡æ¥å…¥æŒ‡å—ï¼ˆå°±ä¸€é¡µè€Œå·²ï¼‰ï¼š[æˆ³æˆ‘](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319)


### å·¥å…·
- å®˜æ–¹æ¥å£è°ƒè¯•å·¥å…·ï¼ˆå¾ˆæ–¹ä¾¿ï¼‰ï¼š [æˆ³æˆ‘](https://mp.weixin.qq.com/debug)
- å†…ç½‘ç©¿é€natappï¼ˆå…è´¹ï¼‰ï¼š[æˆ³æˆ‘](https://natapp.cn/article/natapp_newbie)

### å¸¸è§åè¯é‡Šä¹‰
- appID
> ç”¨æ¥åŠ å¯†ç”¨è‡ªåŠ¨ç”Ÿæˆçš„
- appsecret
> ç”¨æ¥åŠ å¯†ç”¨è‡ªåŠ¨ç”Ÿæˆçš„
- Token
> ç”¨æ¥åŠ å¯†ç”¨ï¼Œå¯ä»¥éšä¾¿å†™

- access_token
> è°ƒç”¨å¾®ä¿¡æ¥å£çš„å‡­æ®ï¼Œå®ƒæ˜¯æœ‰è°ƒç”¨æ¬¡æ•°é™åˆ¶çš„ï¼Œè€Œä¸”æœ‰å­˜æ´»æ—¶é—´çš„ 

### è·å–ç”¨æˆ·ä¿¡æ¯æµç¨‹
![image](https://raw.githubusercontent.com/liueleven/study/master/%E5%9B%BE%E5%BA%93/02-wechat/01-%E5%BE%AE%E4%BF%A1%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%B5%81%E7%A8%8B.png)

### ç”³è¯·ä¸€ä¸ªæµ‹è¯•å·
> å¾®ä¿¡å…¬ä¼—å·æ ¹æ®ç±»å‹ä¸åŒï¼Œè°ƒç”¨æ¥å£æƒé™ä¹Ÿä¸åŒï¼Œæ™®é€šå¼€å‘äººå‘˜å¯ä»¥ç”³è¯·ä¸€ä¸ªæµ‹è¯•è´¦å·ï¼Œå°±æ‹¥æœ‰æœ€é«˜æƒé™äº†

- ç”³è¯·ä¸€ä¸ªå…¬ä¼—å·ç™»å½•è¿›å»
- æ‰¾åˆ°å¼€å‘è€…å·¥å…·
- è¿›å…¥å…¬ä¼—å¹³å°æµ‹è¯•å¸å·ï¼Œè¿›è¡Œç”³è¯·

ç”³è¯·æˆåŠŸåï¼Œè·å–appIdï¼Œappsecretï¼Œè‡ªå®šä¹‰ä¸€ä¸ªtoken

### åˆå§‹åŒ–å·¥ç¨‹ï¼Œæ¥å…¥å…¬ä¼—å·
- æ‰“å¼€IDEï¼Œåœ¨mavenä¸­æ·»åŠ ä¾èµ–
  ```
   <dependency>
        <groupId>com.github.binarywang</groupId>
        <artifactId>weixin-java-mp</artifactId>
        <version>3.0.0</version>
    </dependency>
  ```
- åœ¨application.ymlä¸­å†™å¥½å¾®ä¿¡å‚æ•°ï¼šappIdï¼Œappsecretï¼Œtoken
- åˆ›å»ºä¸€ä¸ªç±»ï¼Œå°†å¾®ä¿¡å‚æ•°å°è£…æˆä¸€ä¸ªBeanï¼Œæ–¹ä¾¿è°ƒç”¨
    ```
    @ConfigurationProperties(prefix = "wechat")
    @Component
    @Data
    public class WechatMpProperties {
    
      /**
       * åç«¯ip
       */
      public  String backendHost;
      /**
       * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„appid
       */
      private String appId;
    
      /**
       * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„app secret
       */
      private String secret;
    
      /**
       * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„token
       */
      private String token;
    
      /**
       * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„EncodingAESKey
       */
      private String aesKey;
    }  
    ```
- å†™ä¸€ä¸ªcontrollerï¼Œç”¨æ¥æ¥å…¥å¾®ä¿¡å…¬ä¼—å·ï¼Œ[çœ‹è¿™ä¸€é¡µæ–‡æ¡£å°±å¤Ÿäº†](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319)ï¼Œå†™å¥½ç›¸å…³æ ¡éªŒæ–¹æ³•ï¼Œç„¶åæŠŠurlå¡«å†™åˆ°å¾®ä¿¡å…¬ä¼—å·ä¸Šæ¥å…¥ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨natappæ˜ å°„ã€‚**æ³¨æ„ï¼šhttpåªèƒ½ç”¨80ç«¯å£ï¼Œhttpsæ˜¯443ç«¯å£**

### ä¸€ä¸ªé‡è¦çš„æ¥å£
åœ¨è¯¥SDKä¸­è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ¥å£ï¼Œé‡Œé¢å®šä¹‰äº†å¾ˆå¤šæˆ‘ä»¬ä¼šç”¨åˆ°çš„æ¥å£ï¼Œæ¯”å¦‚èœå•åˆ›å»ºï¼ŒäºŒç»´ç åˆ›å»ºï¼Œç”¨æˆ·ä¿¡æ¯è·å–...
> import me.chanjar.weixin.mp.api.WxMpService;

### åˆ›å»ºèœå•
```
    @Autowired
    private WxMpService wxMpService;
    @Autowired
    private WechatMpProperties wechatMpProperties;
private void initMenu() {
    try {
        WxMpMenuService menuService = wxMpService.getMenuService();
        menuService.menuDelete();
        if (logger.isInfoEnabled()) {
            logger.info("=============================>æˆåŠŸåˆ é™¤å¾®ä¿¡èœå•");
        }
        //èœå•
        WxMenu menu = new WxMenu();
        //æŒ‰é’®1
        WxMenuButton competitionMenu = new WxMenuButton();
        competitionMenu.setName("MEGç”µç«");
        //è¿™é‡Œç½‘é¡µæˆæƒurlè¦ä¼ å…¥3ä¸ªå‚æ•°ï¼›1.å°†è·å–åˆ°çš„codeå’Œstateè¿›è¡Œå¤„ç†ï¼›2.ä¼ å…¥æˆæƒä½œç”¨åŸŸï¼›3.è·å–codeå’Œstateåçš„å›è°ƒurlï¼Œéœ€è¦ç¼–ç 
        competitionMenu.setUrl(wxMpService.oauth2buildAuthorizationUrl(wechatMpProperties.getBackendHost() + "/wechat/verity/authorize",WxConsts.OAuth2Scope.SNSAPI_USERINFO,
                URIUtil.encodeURIComponent(wechatMpProperties.getBackendHost() + "/wechat/index")));
        //æŒ‰é’®ç±»å‹
        competitionMenu.setType(WxConsts.MenuButtonType.VIEW);
        menu.getButtons().add(competitionMenu);
        //åˆ›å»ºå­èœå•
        WxMenuButton personalCenterMenu = new WxMenuButton();
        personalCenterMenu.setName("ä¸ªäººä¸­å¿ƒ");
        List<WxMenuButton> subs = new ArrayList<>();
        //æˆ‘çš„å°é˜Ÿ
        WxMenuButton ownTeam = new WxMenuButton();
        ownTeam.setName("æˆ‘çš„å°é˜Ÿ");
        competitionMenu.setUrl(wxMpService.oauth2buildAuthorizationUrl(wechatMpProperties.getBackendHost() + "/wechat/verity",WxConsts.OAuth2Scope.SNSAPI_BASE,
                URIUtil.encodeURIComponent(wechatMpProperties.getBackendHost() + "/wechat/index")));
        ownTeam.setType(WxConsts.MenuButtonType.VIEW);
        subs.add(ownTeam);
        //æˆ‘çš„è´¦å·
        WxMenuButton ownAccount = new WxMenuButton();
        ownAccount.setName("æˆ‘çš„è´¦å·");
        competitionMenu.setUrl(wxMpService.oauth2buildAuthorizationUrl(wechatMpProperties.getBackendHost() + "/wechat/verity",WxConsts.OAuth2Scope.SNSAPI_BASE,
                URIUtil.encodeURIComponent(wechatMpProperties.getBackendHost() + "/wechat/index")));
        ownAccount.setType(WxConsts.MenuButtonType.VIEW);
        subs.add(ownAccount);
        personalCenterMenu.setSubButtons(subs);
        menu.getButtons().add(personalCenterMenu);
        //åˆ›å»ºèœå•
        wxMpService.getMenuService().menuCreate(menu);
        if(logger.isInfoEnabled()) {
            logger.info("=========================>åˆ›å»ºå¾®ä¿¡èœå•æˆåŠŸ");
        }
    }catch (Exception e) {
        logger.error("=========================>åˆ›å»ºå¾®ä¿¡èœå•å¤±è´¥", e);
    }
}
```
### æ‹‰å–ç”¨æˆ·ä¿¡æ¯
```
/**
   * å…¬ä¼—å·è¿›å…¥å…¥å£ï¼Œè¿™é‡Œsdkå·²ç»å¸®æˆ‘ä»¬å°è£…äº†å¥½å¤šï¼Œå¯¹äºAccessTokenè¿‡æœŸä¼šè‡ªåŠ¨å»æ›´æ–°çš„
   * @param code
   * @param state  é‡å®šå‘url
   *
   */
  @GetMapping("/authorize")
  public void authorize(@RequestParam("code") String code,
                          @RequestParam("state") String state, HttpServletResponse response) throws Exception {
    //ä»èœå•è¿›æ¥è·å–åˆ°codeï¼Œæ›´åŠ codeè·å–openId                      
    String openId = wxService.oauth2getAccessToken(code).getOpenId();
    User user = userService.findByOpenid(openId);
    if(null == user) {
      //æ ¹æ®openIdæ‹‰å–ç”¨æˆ·ä¿¡æ¯
      WxMpUser wxMpUser = wxService.getUserService().userInfo(openId,"zh_CN");  //è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¸­æ–‡ç±»å‹
      //var1 æ‹·è´åˆ° var2
      user = new User();
      BeanUtils.copyProperties(wxMpUser,user);
      userService.add(user);
    }
    logger.info("======================openId={},nickname={},state={}", openId,user.getNickname(),state);
    response.sendRedirect(state + "?openId=" + openId);
```
### åˆ›å»ºäºŒç»´ç 
è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸´æ—¶äºŒç»´ç ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡åˆ›å»ºæ°¸ä¹…çš„
```
logger.info("=============================>åˆ›å»ºä¸´æ—¶äºŒç»´ç -----å¼€å§‹");
WxMpQrCodeTicket tmpTicket = wxMpService.getQrcodeService().qrCodeCreateTmpTicket("C113", 604800);//è¿™é‡Œæ˜¯ä¸€å‘¨,æœ€å¤§æ˜¯ä¸€ä¸ªæœˆ
logger.info("=============================>è·å¾—ç¥¨æ ¹------æœ‰æ•ˆæ—¶é—´ï¼š{},ç¥¨æ ¹åç§°: {}, ç¥¨æ ¹URL: {}",tmpTicket.getExpireSeconds(),tmpTicket.getTicket(),tmpTicket.getUrl());
String qrCodeUrl = wxMpService.getQrcodeService().qrCodePictureUrl(tmpTicket.getTicket());
logger.info("=============================>ç”Ÿæˆçš„ä¸´æ—¶äºŒç»´ç URLï¼š{}",qrCodeUrl);
WxMpMenuService menuService = wxMpService.getMenuService();
```

### äº‹ä»¶çš„å¤„ç†
å¦‚å®˜æ–¹ä»‹ç»çš„æ‰€è¯´ï¼Œäº‹ä»¶ç”¨è·¯ç”±çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä¸€å®šè¦åœ¨è·¯ç”±ä¸­æ·»åŠ ï¼Œåé¢å°±ä¼šè‡ªåŠ¨åŒ¹é…åˆ°ç›¸åº”çš„äº‹ä»¶ï¼Œç„¶ååœ¨æ‰§è¡Œ
```
1.åœ¨è·¯ç”±ä¸­æ³¨å†Œç›¸åº”çš„äº‹ä»¶è§„åˆ™ï¼Œå¦‚ï¼š

@Autowired
private SubscribeHandler subscribeHandler;
  
@Bean
public WxMpMessageRouter router(WxMpService wxMpService) {
    final WxMpMessageRouter newRouter = new WxMpMessageRouter(wxMpService);
    // å…³æ³¨äº‹ä»¶è§„åˆ™æ³¨å†Œ
    newRouter.rule().async(false).msgType(WxConsts.XmlMsgType.EVENT)
        .event(WxConsts.EventType.SUBSCRIBE).handler(this.getSubscribeHandler())
        .end();
        
    return newRouter;    
}   

protected SubscribeHandler getSubscribeHandler() {
    return this.subscribeHandler;
  }
  
2.å®šä¹‰ä¸ªSubscribeHandlerçš„ç±»ï¼Œå¦‚ï¼š
@Component
public class SubscribeHandler extends AbstractHandler {

    @Override
    public WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage,
                                    Map<String, Object> context,
                                    WxMpService weixinService,
                                    WxSessionManager sessionManager)
                                    throws WxErrorException {

        this.logger.info("æ–°å…³æ³¨ç”¨æˆ· OPENID: " + wxMessage.getFromUser());
         try {
            return new TextBuilder().build(content, wxMessage, weixinService);
        } catch (Exception e) {
            this.logger.error(e.getMessage(), e);
        }
    }
}        
```
### æœ‹å‹ï¼Œæœ‹å‹åœˆåˆ†äº«åŠŸèƒ½
åœ¨ä»¥å‰ç‰ˆæœ¬ä¸­è¿™äº›åˆ†äº«åªéœ€è¦è®¾ç½®ä¸‹300*300çš„å›¾å°±å¯ä»¥ï¼Œä½†æ˜¯ç°åœ¨ä¸è¡Œäº†ï¼Œæ–‡æ¡£ä¹Ÿæ²¡æœ‰å…·ä½“åŸå› ï¼Œæ‰€ä»¥åªèƒ½å¼•å…¥js-sdkè¿›è¡Œè‡ªå®šä¹‰åˆ†äº«

> å®˜æ–¹æ–‡æ¡£ï¼š[æˆ³æˆ‘](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115)

æŒ‰ç…§æ–‡æ¡£ä¸€æ­¥ä¸€æ­¥æ“ä½œï¼Œæ³¨æ„åŸŸåä¿æŒä¸€è‡´ï¼Œè¿˜æœ‰ä¸€ç‚¹æ˜¯è°ƒç”¨jsæ¥å£æ˜¯éœ€è¦jsapi_ticketä¹Ÿæ˜¯æœ‰è°ƒç”¨é¢‘æ¬¡å’Œè¿‡æœŸæ—¶é—´çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨me.chanjar.weixin.mp.api.WxMpService; è¿™ä¸ªç±»ç”Ÿæˆç­¾å

javaä»£ç 
```
/**
 * 
 * @param url åˆ†äº«å‡ºå»çš„url
 * @return
 * @throws WxErrorException
 */
@GetMapping(value = "/share")
public WxJsapiSignature share(String url) throws WxErrorException {

    WxJsapiSignature wxJsapiSignature = wxService.createJsapiSignature(url);
    return wxJsapiSignature;
}

```
jsä»£ç 

[æˆ³æˆ‘](https://github.com/liueleven/study/blob/master/%E5%89%8D%E7%AB%AF/06-%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%AB%E5%8A%9F%E8%83%BD%E2%80%94%E2%80%94share.js)


### å¼€å‘ä¸­é‡åˆ°çš„é—®é¢˜
##### 1.æœ‰äº›ç”¨æˆ·çš„æ˜µç§°æœ‰emojiï¼Œå½“ä½ æ•°æ®åº“ä¸­å­—ç¬¦é›†æ˜¯utf-8æ’å…¥å°±ä¼šæŠ¥é”™ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹å¼ã€‚ä¸€ç§æ˜¯è¯¥æ•°æ®åº“çš„å­—ç¬¦é›†æ¢æˆutf8mb4,è¿™ç§åªæœ‰mysql5.5ä»¥ä¸Šç‰ˆæœ¬æ‰æ–°åŠ å…¥çš„å­—ç¬¦é›†ï¼›å¦å¤–ä¸€ç§æ˜¯å­˜å…¥æ•°æ®åº“æ—¶å¯¹è¯¥ç”¨æˆ·åè¿›è¡Œç¼–ç ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·
```
<dependency>
  <groupId>com.github.binarywang</groupId>
  <artifactId>java-emoji-converter</artifactId>
  <version>0.1.1</version>
</dependency>
```
å­˜å…¥å’Œè¯»å–
```
EmojiConverter emojiConverter = EmojiConverter.getInstance();
String alias =  emojiConverter.toAlias(nickname);   //:wink::kissing_smiling_eyes:
String nickname = emojiConverter.toUnicode(alias);//åä¸€ ğŸ˜‰ğŸ˜™
```

##### 2.sdkè‡ªå¸¦çš„ç±»WxMpMessageRouterã€WxMpServiceæç¤ºæ— æ³•æ³¨å…¥
```
å¯ä»¥å‚è€ƒç»™çš„demoï¼Œnewä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨æ–¹æ³•ä¸ŠåŠ æ³¨è§£@Bean
@Bean
public WxMpService wxMpService(WxMpConfigStorage configStorage) {
    WxMpService wxMpService = new WxMpServiceImpl();
    wxMpService.setWxMpConfigStorage(configStorage);
    return wxMpService;
}
```

##### 3.å¼•ç”¨js-sdkæ¥å£æœ€åå¼€å¯debugæ¨¡å¼ï¼Œå¯ä»¥çœ‹åˆ°æç¤ºï¼Œurl domain invalidï¼Œç­¾åæ— æ•ˆç­‰é”™è¯¯æç¤º
```
å¼ºè°ƒä¸¤ç‚¹ï¼š
1.åŸŸåæ˜¯åŸŸåï¼Œä¸å¸¦http://çš„ï¼Œurlæ˜¯urlè¿™ä¸ªè¦åŒºåˆ†æ¸…æ¥š
2.ç­¾åæ— æ•ˆæ˜¯å’Œä¹‹å‰æ¥å…¥å·®ä¸å¤šï¼Œå…·ä½“å¯ä»¥ç”¨å†…ç½‘ç©¿é€å·¥å…·natappè¿›è¡Œè°ƒè¯•
```

